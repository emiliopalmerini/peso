<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Peso</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/min.css">
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="theme-ink density-comfortable style-minimal">
    <header class="topbar">
        <div class="container topbar__inner">
            <a class="brand" href="/">Peso</a>
            <div class="topbar__user">
                <span class="topbar__user-name">{{.UserName}}</span>
                <a href="/logout" class="logout-link">Esci</a>
            </div>
        </div>
    </header>

    <main class="container page">
        <!-- Hero Stat Card -->
        <section class="page__section">
            <div class="stat-hero" id="stat-hero"
                 hx-get="/users/{{.UserID}}/stat-hero"
                 hx-trigger="load, weight-updated from:body"
                 hx-swap="innerHTML">
                <div class="skeleton" style="height: 60px; width: 150px; margin: 0 auto;"></div>
            </div>
        </section>

        <!-- Stat Pills -->
        <section class="page__section">
            <div class="stat-pills" id="stat-pills"
                 hx-get="/users/{{.UserID}}/stat-pills"
                 hx-trigger="load, weight-updated from:body, goal-updated from:body"
                 hx-swap="innerHTML">
                <div class="stat-pill"><div class="skeleton" style="height: 50px;"></div></div>
                <div class="stat-pill"><div class="skeleton" style="height: 50px;"></div></div>
            </div>
        </section>

        <!-- Goal panel (for goal form) -->
        <section class="page__section"><div id="panel"></div></section>

        <!-- Weight Chart -->
        <section class="page__section">
            <div class="chart">
                <div class="chart__head">
                    <div>
                        <span>Andamento</span>
                        <span id="goal-badge"
                              hx-get="/users/{{.UserID}}/goal-badge"
                              hx-trigger="load, weight-updated from:body, goal-updated from:body"></span>
                    </div>
                    <div class="period-chips" id="periodChips">
                        <button class="period-chip" data-period="week">1S</button>
                        <button class="period-chip" data-period="month">1M</button>
                        <button class="period-chip period-chip--active" data-period="3months">3M</button>
                        <button class="period-chip" data-period="6months">6M</button>
                        <button class="period-chip" data-period="year">1A</button>
                        <button class="period-chip" data-period="all">Tutto</button>
                    </div>
                </div>
                <div class="chart__body">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Recent Weights -->
        <section class="page__section">
            <div class="section-header">
                <span class="section-header__title">Storico</span>
            </div>
            <div class="list" id="recent-weights"
                 hx-get="/users/{{.UserID}}/recent-weights"
                 hx-trigger="load, weight-updated from:body">
                <div class="row"><span class="text-muted">Caricamento...</span></div>
            </div>
        </section>

        <!-- Goal Summary (collapsible) -->
        <section class="page__section">
            <details>
                <summary>Obiettivo</summary>
                <div class="details-content" id="goal-summary"
                     hx-get="/users/{{.UserID}}/goal-summary"
                     hx-trigger="load, weight-updated from:body, goal-updated from:body">
                    <div class="text-muted">Caricamento...</div>
                </div>
            </details>
        </section>
    </main>

    <!-- FAB -->
    <button class="fab" id="fab" aria-label="Aggiungi peso">
        <svg class="fab__icon" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet-backdrop" id="sheetBackdrop"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="bottom-sheet__handle"></div>
        <div class="bottom-sheet__header">
            <h2 class="bottom-sheet__title">Registra peso</h2>
        </div>
        <div class="bottom-sheet__content">
            <div class="weight-input-display">
                <span class="weight-input-display__value" id="weightDisplay">--.-</span>
                <span class="weight-input-display__unit">kg</span>
                <div class="weight-input-display__date" id="dateDisplay">Oggi</div>
            </div>
            <div class="numpad">
                <button class="numpad__key" data-key="1">1</button>
                <button class="numpad__key" data-key="2">2</button>
                <button class="numpad__key" data-key="3">3</button>
                <button class="numpad__key" data-key="4">4</button>
                <button class="numpad__key" data-key="5">5</button>
                <button class="numpad__key" data-key="6">6</button>
                <button class="numpad__key" data-key="7">7</button>
                <button class="numpad__key" data-key="8">8</button>
                <button class="numpad__key" data-key="9">9</button>
                <button class="numpad__key" data-key=".">.</button>
                <button class="numpad__key" data-key="0">0</button>
                <button class="numpad__key" data-key="backspace">
                    <svg viewBox="0 0 24 24"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                </button>
            </div>
            <button class="btn btn-primary btn--block" id="saveWeight">Salva</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pullIndicator">
        <svg class="pull-indicator__icon" viewBox="0 0 24 24">
            <path d="M23 4v6h-6M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
    </div>

    <script>
        // ============================================================
        // State
        // ============================================================
        let chart;
        let currentPeriod = '3months';
        let weightInput = '';
        let lastWeight = null;
        const userId = '{{.UserID}}';
        const ctx = document.getElementById('weightChart').getContext('2d');
        const goal = {{ if .ActiveGoal }}{{ if and .CreatedAt .StartWeight }} { targetWeight: {{.ActiveGoal.TargetWeight}}, targetDate: "{{.ActiveGoal.TargetDate}}", unit: "{{.ActiveGoal.Unit}}", createdAt: "{{.CreatedAt}}", startWeight: {{.StartWeight}} }{{ else }} { targetWeight: {{.ActiveGoal.TargetWeight}}, targetDate: "{{.ActiveGoal.TargetDate}}", unit: "{{.ActiveGoal.Unit}}" }{{ end }}{{ else }} null {{ end }};

        // ============================================================
        // Toast Notifications
        // ============================================================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.innerHTML = `<span class="toast__message">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast--out');
                setTimeout(() => toast.remove(), 200);
            }, duration);
        }

        // ============================================================
        // Bottom Sheet
        // ============================================================
        const fab = document.getElementById('fab');
        const backdrop = document.getElementById('sheetBackdrop');
        const sheet = document.getElementById('bottomSheet');
        const weightDisplay = document.getElementById('weightDisplay');
        const saveBtn = document.getElementById('saveWeight');

        function openSheet() {
            backdrop.classList.add('bottom-sheet-backdrop--open');
            sheet.classList.add('bottom-sheet--open');
            document.body.style.overflow = 'hidden';
            // Pre-fill with last weight if available
            if (lastWeight) {
                weightInput = lastWeight.toString();
                updateWeightDisplay();
            }
        }

        function closeSheet() {
            backdrop.classList.remove('bottom-sheet-backdrop--open');
            sheet.classList.remove('bottom-sheet--open');
            document.body.style.overflow = '';
            weightInput = '';
            updateWeightDisplay();
        }

        function updateWeightDisplay() {
            weightDisplay.textContent = weightInput || '--.-';
        }

        fab.addEventListener('click', openSheet);
        backdrop.addEventListener('click', closeSheet);

        // Numpad handling
        document.querySelectorAll('.numpad__key').forEach(key => {
            key.addEventListener('click', () => {
                const value = key.dataset.key;
                if (value === 'backspace') {
                    weightInput = weightInput.slice(0, -1);
                } else if (value === '.') {
                    if (!weightInput.includes('.') && weightInput.length > 0) {
                        weightInput += '.';
                    }
                } else {
                    // Limit to format XXX.X
                    const parts = weightInput.split('.');
                    if (parts.length === 2 && parts[1].length >= 1) return;
                    if (parts.length === 1 && parts[0].length >= 3 && !weightInput.includes('.')) return;
                    weightInput += value;
                }
                updateWeightDisplay();
            });
        });

        // Save weight
        saveBtn.addEventListener('click', async () => {
            const weight = parseFloat(weightInput);
            if (isNaN(weight) || weight < 10 || weight > 500) {
                showToast('Inserisci un peso valido (10-500 kg)', 'error');
                return;
            }
            try {
                const formData = new FormData();
                formData.append('user_id', userId);
                formData.append('weight', weight);
                const response = await fetch('/api/weights', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    closeSheet();
                    fab.classList.add('fab--success');
                    setTimeout(() => fab.classList.remove('fab--success'), 600);
                    showToast('Peso salvato', 'success');
                    document.body.dispatchEvent(new CustomEvent('weight-updated'));
                    lastWeight = weight;
                } else {
                    showToast('Errore nel salvataggio', 'error');
                }
            } catch (e) {
                showToast('Errore di connessione', 'error');
            }
        });

        // ============================================================
        // FAB scroll behavior
        // ============================================================
        let lastScrollY = 0;
        let fabHidden = false;
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            if (currentScrollY > lastScrollY && currentScrollY > 100 && !fabHidden) {
                fab.classList.add('fab--hidden');
                fabHidden = true;
            } else if (currentScrollY < lastScrollY && fabHidden) {
                fab.classList.remove('fab--hidden');
                fabHidden = false;
            }
            lastScrollY = currentScrollY;
        }, { passive: true });

        // ============================================================
        // Period Chips
        // ============================================================
        document.getElementById('periodChips').addEventListener('click', (e) => {
            const chip = e.target.closest('.period-chip');
            if (!chip) return;
            document.querySelectorAll('.period-chip').forEach(c => c.classList.remove('period-chip--active'));
            chip.classList.add('period-chip--active');
            currentPeriod = chip.dataset.period;
            renderChart();
        });

        // ============================================================
        // Pull to Refresh
        // ============================================================
        let pullStartY = 0;
        let isPulling = false;
        const pullIndicator = document.getElementById('pullIndicator');

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                pullStartY = e.touches[0].clientY;
                isPulling = true;
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            const pullDistance = e.touches[0].clientY - pullStartY;
            if (pullDistance > 60 && window.scrollY === 0) {
                pullIndicator.classList.add('pull-indicator--visible');
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            if (pullIndicator.classList.contains('pull-indicator--visible')) {
                pullIndicator.classList.add('pull-indicator--refreshing');
                // Trigger refresh
                document.body.dispatchEvent(new CustomEvent('weight-updated'));
                renderChart();
                setTimeout(() => {
                    pullIndicator.classList.remove('pull-indicator--visible', 'pull-indicator--refreshing');
                }, 1000);
            }
            isPulling = false;
        }, { passive: true });

        // ============================================================
        // Chart
        // ============================================================
        function itToDate(itDate) {
            const [d,m,y] = itDate.split('/');
            return new Date(y, m-1, d);
        }

        function aggregateDailyAverage(data) {
            const groups = new Map();
            for (const w of data) {
                const d = w.date;
                if (!groups.has(d)) groups.set(d, []);
                groups.get(d).push(w.value);
            }
            const dates = Array.from(groups.keys()).sort((a, b) => itToDate(a) - itToDate(b));
            return dates.map(d => {
                const vals = groups.get(d);
                return { date: d, value: vals.reduce((a,b)=>a+b,0)/vals.length };
            });
        }

        async function renderChart() {
            try {
                const [data, latest] = await Promise.all([
                    fetch(`/api/weights/${userId}?period=${currentPeriod}`).then(r=>r.json()).catch(()=>null),
                    fetch(`/api/weights/latest/${userId}`).then(r=>r.ok?r.json():null).catch(()=>null)
                ]);

                if (latest && latest.value) {
                    lastWeight = latest.value;
                }

                if (!data || !Array.isArray(data) || data.length === 0) {
                    document.querySelector('.chart__body').innerHTML = '<div class="empty-state">Nessun dato</div>';
                    return;
                }

                const averaged = aggregateDailyAverage(data);
                const labels = averaged.map(p => p.date);
                const avgValues = averaged.map(p => p.value);
                const rawPoints = data.map(w => ({ x: w.date, y: w.value, t: w.time }));

                const allWeightValues = [...avgValues, ...rawPoints.map(p => p.y)];
                if (goal) allWeightValues.push(parseFloat(goal.targetWeight));
                const minWeight = Math.min(...allWeightValues);
                const maxWeight = Math.max(...allWeightValues);
                const padding = (maxWeight - minWeight) * 0.1 || 1;
                const yMin = Math.max(0, minWeight - padding);
                const yMax = maxWeight + padding;

                const config = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'scatter',
                                label: 'Misurazioni',
                                data: rawPoints,
                                parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                                showLine: false,
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointBorderWidth: 0,
                                pointBackgroundColor: 'rgb(17, 17, 17)'
                            },
                            {
                                type: 'line',
                                label: 'Media',
                                data: avgValues,
                                borderColor: 'rgb(17, 17, 17)',
                                backgroundColor: 'rgba(17, 17, 17, 0.05)',
                                tension: 0.3,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBorderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: 'rgb(17, 17, 17)',
                                fill: true
                            },
                            {
                                type: 'line',
                                label: 'Obiettivo',
                                data: (goal && labels.length > 0) ? [{ x: labels[0], y: parseFloat(goal.targetWeight) }, { x: labels[labels.length - 1], y: parseFloat(goal.targetWeight) }] : [],
                                parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                                borderColor: 'rgb(156, 163, 175)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                showLine: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'nearest', intersect: false },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgb(17, 17, 17)',
                                titleFont: { size: 12 },
                                bodyFont: { size: 14, weight: 'bold' },
                                padding: 10,
                                cornerRadius: 8,
                                callbacks: {
                                    title: (items) => items[0]?.label || '',
                                    label: (ctx) => {
                                        if (ctx.dataset.type === 'scatter') {
                                            const time = ctx.raw?.t || '';
                                            return time ? `${ctx.formattedValue} kg (${time})` : `${ctx.formattedValue} kg`;
                                        }
                                        return `Media: ${ctx.formattedValue} kg`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                min: yMin,
                                max: yMax,
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 }, maxTicksLimit: 6 }
                            }
                        }
                    }
                };

                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = rawPoints;
                    chart.data.datasets[1].data = avgValues;
                    const goalLineData = (goal && labels.length > 0) ? [{ x: labels[0], y: parseFloat(goal.targetWeight) }, { x: labels[labels.length - 1], y: parseFloat(goal.targetWeight) }] : [];
                    chart.data.datasets[2].data = goalLineData;
                    chart.options.scales.y.min = yMin;
                    chart.options.scales.y.max = yMax;
                    chart.update('none');
                } else {
                    chart = new Chart(ctx, config);
                }
            } catch (e) {
                console.error('Chart error:', e);
                document.querySelector('.chart__body').innerHTML = '<div class="empty-state">Errore caricamento</div>';
            }
        }

        // ============================================================
        // HTMX Event Handling
        // ============================================================
        document.body.addEventListener('htmx:afterRequest', (e) => {
            if (e.detail.successful && e.detail.verb === 'delete') {
                showToast('Peso eliminato', 'success');
            }
        });

        document.body.addEventListener('htmx:responseError', (e) => {
            showToast('Errore durante l\'operazione', 'error');
        });

        // ============================================================
        // Init
        // ============================================================
        document.addEventListener('DOMContentLoaded', renderChart);
        document.body.addEventListener('weight-updated', renderChart);
    </script>
</body>
</html>
