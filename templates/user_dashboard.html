<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard {{.UserID | title}}</title>
    <link rel="stylesheet" href="/static/min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="style-minimal">
    <header class="topbar">
        <div class="container topbar__inner">
            <a class="brand" href="/">Peso</a>
        </div>
    </header>

    <main class="container page">
        <h1 class="page__title">Dashboard {{.UserID | title}}</h1>

        <section class="page__section">
            <div class="list" id="recent-weights">
                {{if .RecentWeights}}
                    {{range .RecentWeights}}
                    <div class="row">
                        <div>{{.Date}}</div>
                        <div>{{.Value}} {{.Unit}}{{if .Notes}} Â· <span class="caption">{{.Notes}}</span>{{end}}</div>
                    </div>
                    {{end}}
                {{else}}
                    <div class="row">
                        <div class="caption">Nessun peso registrato di recente</div>
                    </div>
                {{end}}
            </div>
            <div class="actions">
                <button hx-get="/users/{{.UserID}}/weight-form" hx-target="#weight-form" class="btn btn-primary">Registra Peso</button>
            </div>
            <div id="weight-form"></div>
        </section>

        <section class="page__section">
            <div class="list">
                <div class="row"><strong>Obiettivo</strong></div>
                {{if .ActiveGoal}}
                    <div class="row"><div>Target</div><div>{{.ActiveGoal.TargetWeight}} {{.ActiveGoal.Unit}}</div></div>
                    <div class="row"><div>Scadenza</div><div>{{.ActiveGoal.TargetDate}}</div></div>
                    {{if .Progress}}
                    <div class="row"><div>Da perdere/guadagnare</div><div>{{.Progress.WeightToLose}} kg</div></div>
                    <div class="row"><div>Giorni rimanenti</div><div>{{.Progress.DaysRemaining}}</div></div>
                    {{end}}
                {{else}}
                    <div class="row"><div class="caption">Nessun obiettivo attivo</div></div>
                    <div class="actions"><button class="btn btn-primary">Imposta Obiettivo</button></div>
                {{end}}
            </div>
        </section>

        <section class="page__section">
            <div class="chart">
                <div class="chart__head">Andamento Peso</div>
                <div class="chart__body">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <script>
        fetch('/api/weights/{{.UserID}}?period=3months')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('weightChart').getContext('2d');
                const labels = data.map(w => w.date);
                const weights = data.map(w => w.value);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Peso (kg)',
                            data: weights,
                            borderColor: 'rgb(17, 17, 17)',
                            backgroundColor: 'rgba(17, 17, 17, 0.05)',
                            tension: 0.2,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.06)' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
                const body = document.querySelector('.chart__body');
                if (body) body.innerHTML = '<div class="caption">Errore nel caricamento del grafico</div>';
            });
    </script>
</body>
</html>
