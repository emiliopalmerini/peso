<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard {{.UserID | title}}</title>
    <link rel="stylesheet" href="/static/min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="style-minimal">
    <header class="topbar">
        <div class="container topbar__inner">
            <a class="brand" href="/">Peso</a>
        </div>
    </header>

    <main class="container page">
        <h1 class="page__title">Dashboard {{.UserID | title}}</h1>

        <section class="page__section">
            <div class="list" id="recent-weights" 
                 hx-get="/users/{{.UserID}}/recent-weights" 
                 hx-trigger="load, weight-updated from:body">
                <div class="row"><div class="caption">Caricamentoâ€¦</div></div>
            </div>
            <div class="actions">
                <button hx-get="/users/{{.UserID}}/weight-form" hx-target="#weight-form" class="btn btn-primary">Registra Peso</button>
            </div>
            <div id="weight-form"></div>
        </section>

        <section class="page__section">
            <div class="list">
                <div class="row"><strong>Obiettivo</strong></div>
                {{if .ActiveGoal}}
                    <div class="row"><div>Target</div><div>{{.ActiveGoal.TargetWeight}} {{.ActiveGoal.Unit}}</div></div>
                    <div class="row"><div>Scadenza</div><div>{{.ActiveGoal.TargetDate}}</div></div>
                    {{if .Progress}}
                    <div class="row"><div>Da perdere/guadagnare</div><div>{{.Progress.WeightToLose}} kg</div></div>
                    <div class="row"><div>Giorni rimanenti</div><div>{{.Progress.DaysRemaining}}</div></div>
                    {{end}}
                {{else}}
                    <div class="row"><div class="caption">Nessun obiettivo attivo</div></div>
                    <div class="actions"><button class="btn btn-primary">Imposta Obiettivo</button></div>
                {{end}}
            </div>
        </section>

        <section class="page__section">
            <div class="chart">
                <div class="chart__head" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div>Andamento Peso</div>
                    <div>
                        <label for="periodSelect" class="caption" style="margin-right:6px;">Periodo</label>
                        <select id="periodSelect">
                            <option value="week">1 settimana</option>
                            <option value="month">1 mese</option>
                            <option value="3months" selected>3 mesi</option>
                            <option value="6months">6 mesi</option>
                            <option value="year">1 anno</option>
                            <option value="all">Tutto</option>
                        </select>
                    </div>
                </div>
                <div class="chart__body">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <script>
        let chart;
        const ctx = document.getElementById('weightChart').getContext('2d');

        function aggregateDailyAverage(data) {
            const groups = new Map();
            for (const w of data) {
                const d = w.date; // already YYYY-MM-DD
                if (!groups.has(d)) groups.set(d, []);
                groups.get(d).push(w.value);
            }
            const dates = Array.from(groups.keys()).sort();
            const averaged = dates.map(d => {
                const vals = groups.get(d);
                const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
                return { date: d, value: avg };
            });
            return averaged;
        }

        async function renderChart() {
            try {
                const periodEl = document.getElementById('periodSelect');
                const period = periodEl ? periodEl.value : '3months';
                const res = await fetch(`/api/weights/{{.UserID}}?period=${period}`);
                const data = await res.json();
                const averaged = aggregateDailyAverage(data);
                const labels = averaged.map(p => p.date);
                const avgValues = averaged.map(p => p.value);
                const rawPoints = data.map(w => ({ x: w.date, y: w.value }));

                const config = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'scatter',
                                label: 'Misurazioni',
                                data: rawPoints,
                                parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                                showLine: false,
                                pointRadius: 3,
                                pointHoverRadius: 4,
                                pointBorderWidth: 0,
                                pointBackgroundColor: 'rgb(17, 17, 17)'
                            },
                            {
                                type: 'line',
                                label: 'Media giornaliera',
                                data: avgValues,
                                borderColor: 'rgb(17, 17, 17)',
                                backgroundColor: 'rgba(17, 17, 17, 0.05)',
                                tension: 0.2,
                                pointRadius: 5,
                                pointHoverRadius: 6,
                                pointBorderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: 'rgb(17, 17, 17)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.06)' } },
                            x: { grid: { display: false } }
                        }
                    }
                };

                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = rawPoints;
                    chart.data.datasets[1].data = avgValues;
                    chart.update();
                } else {
                    chart = new Chart(ctx, config);
                }
            } catch (e) {
                console.error('Error loading chart data:', e);
                const body = document.querySelector('.chart__body');
                if (body) body.innerHTML = '<div class="caption">Errore nel caricamento del grafico</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', renderChart);
        document.body.addEventListener('weight-updated', renderChart);
        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'periodSelect') {
                renderChart();
            }
        });
    </script>
</body>
</html>
